<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-10-15">
<meta name="description" content="Learn about the core concepts of causal inference and the motivations for causal analysis with the help of simulation. Beginners to causal inference welcome!">

<title>Causal Inference for Casuals – Brian Lookabaugh</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../images/stickerv2.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../images/stickerv2.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Brian Lookabaugh</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../resume/index.html"> 
<span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/brian-lookabaugh-phd-372ab31a1/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Brian-Lookabaugh"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:brianlookabaughjr@gmail.com"> <i class="bi bi-envelope" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro">Intro</a></li>
  <li><a href="#description-prediction-and-causation" id="toc-description-prediction-and-causation" class="nav-link" data-scroll-target="#description-prediction-and-causation">Description, Prediction, and Causation</a></li>
  <li><a href="#data-are-dumb" id="toc-data-are-dumb" class="nav-link" data-scroll-target="#data-are-dumb">Data are Dumb</a></li>
  <li><a href="#the-fundamental-problem-of-causal-inference" id="toc-the-fundamental-problem-of-causal-inference" class="nav-link" data-scroll-target="#the-fundamental-problem-of-causal-inference">The Fundamental Problem of Causal Inference</a></li>
  <li><a href="#the-power-of-randomization" id="toc-the-power-of-randomization" class="nav-link" data-scroll-target="#the-power-of-randomization">The Power of Randomization</a></li>
  <li><a href="#when-experiments-fall-short" id="toc-when-experiments-fall-short" class="nav-link" data-scroll-target="#when-experiments-fall-short">When Experiments Fall Short</a></li>
  <li><a href="#no-unobserved-confounding-and-sensitivity-analyses" id="toc-no-unobserved-confounding-and-sensitivity-analyses" class="nav-link" data-scroll-target="#no-unobserved-confounding-and-sensitivity-analyses">No Unobserved Confounding and Sensitivity Analyses</a></li>
  <li><a href="#dont-be-a-control-freak-overadjustment-bias" id="toc-dont-be-a-control-freak-overadjustment-bias" class="nav-link" data-scroll-target="#dont-be-a-control-freak-overadjustment-bias">Don’t Be a Control Freak! Overadjustment Bias</a>
  <ul class="collapse">
  <li><a href="#mediators" id="toc-mediators" class="nav-link" data-scroll-target="#mediators">Mediators</a></li>
  <li><a href="#colliders" id="toc-colliders" class="nav-link" data-scroll-target="#colliders">Colliders</a></li>
  <li><a href="#ancestors-of-outcome-and-treatment" id="toc-ancestors-of-outcome-and-treatment" class="nav-link" data-scroll-target="#ancestors-of-outcome-and-treatment">Ancestors of Outcome and Treatment</a></li>
  </ul></li>
  <li><a href="#positivity-and-treatment-effects" id="toc-positivity-and-treatment-effects" class="nav-link" data-scroll-target="#positivity-and-treatment-effects">Positivity and Treatment Effects</a></li>
  <li><a href="#consistency" id="toc-consistency" class="nav-link" data-scroll-target="#consistency">Consistency</a></li>
  <li><a href="#non-interference" id="toc-non-interference" class="nav-link" data-scroll-target="#non-interference">Non-Interference</a></li>
  <li><a href="#beyond-regression-and-the-cross-sectional" id="toc-beyond-regression-and-the-cross-sectional" class="nav-link" data-scroll-target="#beyond-regression-and-the-cross-sectional">Beyond Regression and the Cross-Sectional</a></li>
  <li><a href="#readings-to-get-you-started" id="toc-readings-to-get-you-started" class="nav-link" data-scroll-target="#readings-to-get-you-started">Readings to Get You Started</a>
  <ul class="collapse">
  <li><a href="#general-introduction-to-causal-inference" id="toc-general-introduction-to-causal-inference" class="nav-link" data-scroll-target="#general-introduction-to-causal-inference">General Introduction to Causal Inference</a></li>
  <li><a href="#dags-and-control-variables" id="toc-dags-and-control-variables" class="nav-link" data-scroll-target="#dags-and-control-variables">DAGs and Control Variables</a></li>
  <li><a href="#regression-matching-and-weighting" id="toc-regression-matching-and-weighting" class="nav-link" data-scroll-target="#regression-matching-and-weighting">Regression, Matching, and Weighting</a></li>
  <li><a href="#causal-inference-beyond-the-cross-sectional" id="toc-causal-inference-beyond-the-cross-sectional" class="nav-link" data-scroll-target="#causal-inference-beyond-the-cross-sectional">Causal Inference Beyond the Cross-Sectional</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Causal Inference for Casuals</h1>
  <div class="quarto-categories">
    <div class="quarto-category">causal inference</div>
    <div class="quarto-category">simulation</div>
    <div class="quarto-category">dags</div>
    <div class="quarto-category">regression</div>
  </div>
  </div>

<div>
  <div class="description">
    Learn about the core concepts of causal inference and the motivations for causal analysis with the help of simulation. Beginners to causal inference welcome!
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 15, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dplyr"</span>, <span class="co"># Data Manipulation</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggdag"</span>, <span class="co"># Visualizing DAGs</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggplot2"</span>, <span class="co"># Data Visualization</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"scales"</span>, <span class="co"># Plotting Percentage Values</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">install =</span> <span class="cn">FALSE</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a Custom Theme - Taken From Andrew Heiss's Blogs</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>blog_theme <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span>  <span class="co"># Start with theme_bw</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey80"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="intro" class="level1">
<h1>Intro</h1>
<p>In the interest of being direct, I want to state upfront that the purpose of this blog is to serve as a singular introductory resource to causal inference that anyone with a background in applied statistics can follow. This blog will cover what causal inference is, why it matters, and general practical matters that are important when doing applied causal inference. To root some of the conceptual aspects of causal inference in something tangible that the reader can observe, this blog will rely on simulated data. For those unfamiliar with simulation, the prior sentence might sound a bit vague. However, I promise that using simulation is an extremely powerful teaching mechanism!</p>
</section>
<section id="description-prediction-and-causation" class="level1">
<h1>Description, Prediction, and Causation</h1>
<p>To understand causal inference, it’s important to contrast the goal of making causal inferences with other scientific endeavors. Broadly speaking, you can classify any contribution to scientific literature towards one of three different objectives:</p>
<ul>
<li><strong>Description</strong>: Descriptive research refers to any scholarship that seeks to define, measure, or report raw facts about some phenomenon of interest. If you are asking a “who?”, “what?”, “when?”, or “where?” question, you are asking a <em>descriptive</em> question. What state has the highest rate of police arrests? What type of individuals were most likely to get the COVID-19 vaccine? When do people typically buy their first house? These are all descriptive questions because they are asking factual questions about the world that can be answered by the accurate collection of information. <em>Accurately</em> collecting information is also a descriptive task. How should democracy be measured? Is our survey sample on American preferences for president reflective of the population’s attitudes? Again, these questions are all super diverse, but they all are seeking answers to better describe the world. I generally like to break descriptive research into these four sub-categories:
<ul>
<li><em>Measurement</em>: How should <span class="math inline">\(X\)</span> be measured? (i.e.&nbsp;intelligence, economic development, war, etc.) Answers the “what?” question.</li>
<li><em>Inference</em>: In the case where we cannot measure a population (this is true for most social science inquiry), we settle for measuring a sample. How can we be sure that our descriptive measures for our sample are valid for the broader population? This is also a descriptive task.</li>
<li><em>EDA</em>: EDA (exploratory data analysis) is a sort of informal term that refers to the process of exploring the data prior to any sort of advanced analysis. Typically, this ends up being a bunch of very common <em>descriptive</em> visualizations. Things like maps (“where?”), time series line plots (“when?”), and grouped bar charts (“who?”).</li>
<li><em>Correlation</em>: Yep, any sort of correlational/associational analysis <em>is</em> descriptive. Correlation is just a measure of how much variables move with each other. <em>Not</em> whether one variable moving <em>causes</em> another variable to move… If <span class="math inline">\(X\)</span> moves, does <span class="math inline">\(Y\)</span> move too? Again, this is a measure <em>describing</em> how much one variable moves as another variable moves. Too often, researchers want their correlational research to do something more than it is capable of. Naturally, we like to read <em>causal</em> assumptions into correlations, especially when they are dressed up with fancy regression models. However, unless very strict conditions are met (these conditions are the entire purpose of this blog post), measures of correlations are just descriptions.</li>
</ul></li>
<li><strong>Prediction</strong>: The task of prediction indicates a desire to forecast/predict future or unknown values given a set of predictors. This task falls under the broad domain of machine learning where predictors are fed into models/algorithms which “learn” from the data to produce predictions about unknown values. Importantly, the goal of prediction is <em>not</em> to focus on the predictors themselves. Rather, predictors are an important tool in service of the ultimate goal, which is to focus on the predicted outcome. Using the classic linear regression formula as an example (<span class="math inline">\(Y = \beta_0 + \beta_1{X} + \epsilon\)</span>), predictive tasks care about <span class="math inline">\(Y\)</span>. In other words, use whatever model and whatever set of predictors that are best able to predict unknown values of <span class="math inline">\(Y\)</span> correctly. Sometimes, you’ll hear the term “feature importance” used in machine learning to evaluate the most “important” predictors for the model. This term is fine, as long as it is clearly understood that <em>feature importance</em> does not imply <em>causality</em> or <em>effect magnitude</em>. A variable that predicts a lot of variation in <span class="math inline">\(Y\)</span> does not imply that there is a causal relationship, let alone a <em>strong</em> causal relationship. Referring back to my <a href="https://brian-lookabaugh.github.io/website-brianlookabaugh/blog/2024/dynamic-causal-inference/">blog post on dynamic causal inference</a>, ice cream sales are probably a pretty strong predictor of shark attacks, but one should be wary of assuming that these two things are causally related.</li>
<li><strong>Causation</strong>: And now we get to causation. If our goal is causal, we are attempting to answer a “why?” question. For example, we might ask, “why do some countries go to war with each other so much while others are peaceful with each other?” We would then posit some theory explaining why a given variable <em>answers</em>, in part, this question. Causal questions are probably the most common type of questions that researchers in the social sciences are asking. However, because many researchers are trained to avoid using the word “cause”, many never realize that their questions are fundamentally causal. If you are using the words “why?”, “impact”, “effect”, “determinant”, etc., then you are handling a causal question that requires the appropriate methodology for interpretable results. For example, consider whether or not two countries are democratic (<span class="math inline">\(X\)</span>) as a causal explanation for war/peace (<span class="math inline">\(Y\)</span>). We can ask a “why?” question (why are some countries more or less peaceful with each other than others?), and we have offered a partial answer. I say <em>partial</em> because we generally don’t assume that there is a single variable that fully explains the answer to <em>any</em> “why?” question in the social sciences. Going back to the linear regression formula, the goal of causation is distinct from prediction because we do not care about maximizing how well our model predicts <span class="math inline">\(Y\)</span>. Instead, we are focused on building a model that gives <span class="math inline">\(\beta_1{X}\)</span> a causal interpretation. A model that can do this will not necessarily predict <span class="math inline">\(Y\)</span> well. In fact, I would say that a model that predicts <span class="math inline">\(Y\)</span> very well will probably be inappropriate for causal inference (this will become apparent as the blog progresses). As it turns out, causal inference is actually very hard, but tackling these challenges is what scientists are trained to do.</li>
</ul>
</section>
<section id="data-are-dumb" class="level1">
<h1>Data are Dumb</h1>
<p>So, what makes the goal of causal inference so hard? If causal inference was easy, we should be able to just look at the data and find our answers in there. Or maybe just plug a bunch of variables into a regression model and we would magically get causal effects. Unfortunately, while data are very useful, data alone, are very dumb.</p>
<p>And, by very dumb, I mean that data reports what is reports but has no underlying imagination or capability to infer. It’s because of these very reasons that all students eventually come to accept and repeat the mantra “correlation does not mean causation”. Through data alone, we can observe correlations. Sometimes, correlations are good evidence for causation. For example, there’s probably a correlation between your speed and when you get speeding tickets and that correlation likely implies a causal relationship. However, sometimes correlations are terrible evidence for causation. Again, I will cite my ice cream sales-shark attacks correlation as an example.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Simulated Data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>days <span class="ot">&lt;-</span> <span class="dv">365</span> <span class="co"># Number of Days in a Year</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(days, <span class="at">mean =</span> <span class="dv">70</span>, <span class="at">sd =</span> <span class="dv">10</span>), <span class="dv">30</span>), <span class="dv">100</span>) <span class="co"># Temperature</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>shark <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> (temp <span class="sc">-</span> <span class="dv">70</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(days, <span class="at">mean =</span> <span class="fl">0.5</span>, <span class="at">sd =</span> <span class="fl">0.5</span>) <span class="co"># Shark Attacks</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>shark <span class="ot">&lt;-</span> <span class="fu">pmax</span>(shark, <span class="dv">0</span>) <span class="co"># Lowest Shark Attacks Can Go Is Zero</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>shark <span class="ot">&lt;-</span> <span class="fu">floor</span>(shark) <span class="co"># Round This Down (There Can't Be Any 0.5 Shark Attacks)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>ice <span class="ot">&lt;-</span> <span class="dv">15000</span> <span class="sc">+</span> <span class="dv">250</span> <span class="sc">*</span> (temp <span class="sc">-</span> <span class="dv">70</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(days, <span class="at">mean =</span> <span class="dv">2500</span>, <span class="at">sd =</span> <span class="dv">500</span>) <span class="co"># Ice Cream Sales with Random Variation</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(days, temp, shark, ice) <span class="co"># Combine Data</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a Scatter Plot</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim, <span class="fu">aes</span>(<span class="at">x =</span> ice, <span class="at">y =</span> shark)) <span class="sc">+</span> </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Ice Cream Sales per Day"</span>, <span class="at">y =</span> <span class="st">"Shark Attacks per Day"</span>, <span class="at">title =</span> <span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">blog_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/scatterplot-shark-attacks-ice-cream-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Correlation Between Shark Attacks and Ice Cream Sales</figcaption>
</figure>
</div>
</div>
</div>
<p>As a human, we know that something is up here and, intuitively, this cannot be a causal relationship (spoiler, this relationship is confounded by temperature… see my aforementioned blog post for more details). However, our data are dumb, and if we just rely on the data for evidence, we will end up with really dumb conclusions. This is why causal inference gets so hard. To make causal inferences, we either have to rely on <em>very</em> strict research designs that will, for the most part, fail in practice <em>or</em> rely on subjective domain knowledge to pair with the data to <em>get closer</em> to the <em>possibility</em> of estimating causal effects. As enticing as it is to rely on the “data alone”, this is a standard that I, along with many others, would argue results in very bad science because you can’t “mine” data for causal effects. It does not organically exist in the data! You have to use the right tools to find it and not all of these tools are purely statistical!</p>
</section>
<section id="the-fundamental-problem-of-causal-inference" class="level1">
<h1>The Fundamental Problem of Causal Inference</h1>
<p>Causal inference is hard (as I’ve already stated several times) and it is, in part, so hard because causality is a really difficult concept to measure and observe. Think about it… Imagine that you have a pounding headache and are frantically searching for Ibuprofen around the house. You search through your drawers and can’t find any. Only when you clear out the cabinets do you find the expired bottle of Ibuprofen that’s been out of data for 2 years. Should you take it? It’s expired, so what if it harms you? Or, maybe its expiration just means that it’s pain-reliving effects have faded away? Nonetheless, your headache is pounding and you decide to take it.</p>
<p>Three hours later, your headache is gone! Did the expired Ibuprofen work? In other words, did taking that expired Ibuprofen have a <em>causal</em> effect on your headache pain? The very naive answer would be that, yes, it did work. After all, you took the medicine and then your headache went away. Not only is this naive, it’s also just lazy thinking. A number of other things could have been happening before and after taking Ibuprofen that could impact headache severity. For example, perhaps your headache was already on its way out and would have subsided regardless of you taking the expired Ibuprofen. Or, maybe you also decided to drink more water after you swallowed the pill and it was actually the water - not the medicine - that caused your headache to go away. Okay, all these what-ifs, but how should you evaluate the impact of the Ibuprofen instead?</p>
<p>This is where the concept of the counterfactual - something that did not happen, but <em>could</em> have happened - comes in handy. If you wanted to know whether the Ibuprofen worked, you’d need to know your headache status when you took the Ibuprofen (the <em>factual</em>) and your headache status when you <em>didn’t</em> take the Ibuprofen (the <em>counterfactual</em>). If we take the difference between the factual (<span class="math inline">\(Headache_{Ibuprofen}\)</span> ) and the counterfactual (<span class="math inline">\(Headache_{No Ibuprofen}\)</span>), then we could know the exact causal effect of the expired Ibuprofen because the <em>only</em> difference between the factual and counterfactual was the use of the expired Ibuprofen. This way of thinking about causality can be referred to as the Potential Outcomes Framework (POF) and it is the dominant way of thinking about capturing causality in scientific research day.</p>
<p>But there’s a huge problem with the POF… we only ever observe one potential outcome, and, in the case of our expired Ibuprofen, we need two potential outcomes (the outcome when you take it vs.&nbsp;the outcome when you don’t). In the working example, you taking the expired Ibuprofen puts you halfway there, but how are you supposed to make the <em>counterfactual</em> happen where you <em>don’t</em> take it happen? You can wait until you get another headache, but that headache could be substantially different than <em>this</em> headache. By the time you get another headache, your current expired Ibuprofen will be even more expired, and now your “treatment” is different than what it was when you observed the factual. Besides, all sorts of other factors will be different about you the next time you get a headache that might matter (like water intake, stress levels, the potential that you’ve contracted COVID-19, the flu, etc.).</p>
<p>The spoiler alert here is that you <em>cannot</em> observe the counterfactual. Because you took the Ibuprofen, you can’t observe the counterfactual when you didn’t take it. If you had instead <em>not</em> taken the Ibuprofen, you would not be able to observe the counterfactual where you would have taken the Ibuprofen. That fact that at least two potential outcomes are needed for causal inference, but you can only ever observe one, is known as the <em>fundamental problem of causal inference</em>. In its purest sense, concretely observing causality is impossible without a time machine (if you had a time machine, you could take the Ibuprofen and let a day pass, then, take the time machine back to the moment right before you took it, then <em>refrain</em> from taking it, and observe the differences in outcomes). However, the world of causal inference is (mostly) not about guessing games, and you can take advantage of very clever research designs and statistical methods to still observe causality <em>despite</em> the clear logical impossibilities of the fundamental problem of causal inference.</p>
</section>
<section id="the-power-of-randomization" class="level1">
<h1>The Power of Randomization</h1>
<p>Randomization has long been praised as one of the best (some might claim, the “only”) tools to make causal inferences. It is very simple conceptually. To demonstrate this simplicity, imagine that we have 1000 participants in our experiment where we want to test the headache-reducing properties of 2-year expired Ibuprofen. As stated before, you’d really struggle with estimating causal effects for each individual because you would need to know <em>each</em> individual’s unobserved potential outcome. Indeed, estimating such individual-level effects is still incredibly hard and not commonplace in contemporary scientific research. However, we can use randomization to estimate <em>group</em>-level causal effects.</p>
<p>We can do so by simply randomizing who gets access to the treatment - in this case, expired Ibuprofen vs.&nbsp;a placebo. We can randomize via coin flip, a random number generator… really whatever you want so long as the treatment assignment mechanism is truly random. In theory, by randomizing access to the treatment, our treated and control group should, on average, be identical to each other. If our process was truly random, then the number of men/women should be pretty equivalent in the two groups. If our process was truly random, the age distribution should be roughly the same between the treated/control, etc.</p>
<p>This is <em>very</em> important because it deals with the type of problems that <em>observational</em> science struggles with. In observational science, we simply observe what people/units of observation do and try to learn from it. In other words, we don’t have control over who gets access to the treatment. When you don’t have control over the treatment assignment mechanism, causal inference gets really hard. In the context of this example, imagine if we just had to design and publish a survey asking people whether they took expired Ibuprofen. Did they all take the exact amount? Are they being honest in reporting their headache status? What about the people who <em>didn’t</em> respond to the survey? That could be problematic if we’re leaving them out because now we might be struggling with some sort of selection bias. Plus, now we have to think about all of the things that <em>confound</em> the relationship between taking expired Ibuprofen and headache relief. For example, time could be one. Maybe most people take expired Ibuprofen as a last resort after trying to “wait the headache out” but, unbeknownst to them, the headache is already almost over anyways. If that’s true, maybe the expired Ibuprofen doesn’t work, but you would now need to control for it because you don’t have control over the treatment assignment mechanism like you would under a randomized design.</p>
<p>In short, the power of randomization is that it allows us to create groups that can serve as counterfactuals for each other. <span class="math inline">\(Group_{X_1}\)</span> reflects a population where everyone is treated and <span class="math inline">\(Group_{X_0}\)</span> reflects a population where nobody is treated. While the individuals within each group are different, the groups as a unit are identical <em>except</em> for their treatment status. Again, the groups are identical because any characteristic of the group should be evenly distrubuted between the treated and control groups due to randomization. If we observe an average difference in headache severity between the two groups, we can attribute this difference to taking/not taking expired Ibuprofen.</p>
<p>The way I’ve just explained how randomization can help us estimate causal effects really takes advantage of the potential outcomes framework for conceptualizing causality. However, you can also use a tool called a directed acyclic graph (DAG) to demonstrate why randomization is so helpful for making causal inferences. In general, DAGs are incredibly useful for visualizing our causal assumptions between treatment, outcome, and other variables that we might think are relevant to account for. But I think they are also very useful as a teaching tool to demonstrate why randomization works in case the potential outcomes framework didn’t cut it for you.</p>
<p>Consider the DAG below. We have <span class="math inline">\(X\)</span> (some treatment of interest) and <span class="math inline">\(Y\)</span> (some outcome of interest). We would like to estimate the causal effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>, but we have <span class="math inline">\(Z\)</span> as a confounder to account for. <span class="math inline">\(Z\)</span> is a confounder because it causes some change in the likelihood of receiving <span class="math inline">\(X\)</span> and also some change in the values of <span class="math inline">\(Y\)</span>. In the ice cream sales-shark attacks case, temperature is a confounder (Ice cream sales (<span class="math inline">\(X\)</span>) <span class="math inline">\(\leftarrow\)</span> Temperature (<span class="math inline">\(Z\)</span>) <span class="math inline">\(\rightarrow\)</span> Shark attacks (<span class="math inline">\(Y\)</span>). According to this very simple DAG, if we wanted to estimate the causal effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>, we would need to control for <span class="math inline">\(Z\)</span> somehow. If we don’t do this, then the estimated association between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> is at least partially spurious. That is, we know before we even estimate the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> that part of the association is not causal and is instead being caused by <span class="math inline">\(Z\)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>simple_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> X <span class="sc">+</span> Z,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> Z,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">"X"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">7</span>, <span class="at">X =</span> <span class="dv">4</span>, <span class="at">Z =</span> <span class="fl">5.5</span>),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">2</span>, <span class="at">X =</span> <span class="dv">2</span>, <span class="at">Z =</span> <span class="dv">3</span>)),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="st">"Y"</span>, <span class="at">X =</span> <span class="st">"X"</span>, <span class="at">Z =</span> <span class="st">"Z"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert DAG to a Tidy Object for Plotting</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>simple_dag_tidy <span class="ot">&lt;-</span> simple_dag <span class="sc">%&gt;%</span> </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">node_status</span>()</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>status_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">exposure =</span> <span class="st">"#ba4244"</span>, <span class="at">outcome =</span> <span class="st">"#3f6275"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Plot</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simple_dag_tidy, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> status)) <span class="sc">+</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> label, <span class="at">fill =</span> status),</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">nudge_y =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>, <span class="at">fill =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/dag showing confounding-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Simple DAG Showing Confounding</figcaption>
</figure>
</div>
</div>
</div>
<p>In this very simplified case, it might be easy to just go ahead and control for <span class="math inline">\(Z\)</span>. However, keep in mind that there are typically more than just 1 confounder. Also, don’t forget that we don’t know how many confounders there are… We might control for 10 confounders, but we can’t ever be totally sure that we’ve accounted for all of them. Also, even if we did just have 1 confounder to deal with, what if we didn’t have data on <span class="math inline">\(Z\)</span> or what if we couldn’t measure it reliably? All of these concerns are those that motivate the use of randomization and I think the value of randomization can be made very clear with a DAG. Think about it… if we make sure that only random chance is impacting whether someone gets <span class="math inline">\(X\)</span> or not, then the following DAG reflects the randomized treatment assignment process.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>simple_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> Z <span class="sc">+</span> X,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> Random,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">"X"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">7</span>, <span class="at">X =</span> <span class="dv">4</span>, <span class="at">Z =</span> <span class="fl">5.5</span>, <span class="at">Random =</span> <span class="dv">4</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">2</span>, <span class="at">X =</span> <span class="dv">2</span>, <span class="at">Z =</span> <span class="dv">3</span>, <span class="at">Random =</span> <span class="dv">3</span>)),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="st">"Y"</span>, <span class="at">X =</span> <span class="st">"X"</span>, <span class="at">Z =</span> <span class="st">"Z"</span>, <span class="at">Random =</span> <span class="st">"Chance"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert DAG to a Tidy Object for Plotting</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>simple_dag_tidy <span class="ot">&lt;-</span> simple_dag <span class="sc">%&gt;%</span> </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">node_status</span>()</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>status_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">exposure =</span> <span class="st">"#6f1a1a"</span>, <span class="at">outcome =</span> <span class="st">"#384d35"</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Plot</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simple_dag_tidy, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> status)) <span class="sc">+</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> label, <span class="at">fill =</span> status),</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">nudge_y =</span> <span class="fl">0.15</span>, <span class="at">nudge_x =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>, <span class="at">fill =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/dag showing randomization-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Simple DAG Showing Randomization of Treatment</figcaption>
</figure>
</div>
</div>
</div>
<p>Crucially, <span class="math inline">\(Z\)</span> does not impact <span class="math inline">\(X\)</span> anymore (the only thing that impacts <span class="math inline">\(X\)</span> is random chance now), and because <span class="math inline">\(Z\)</span> does not impact <span class="math inline">\(X\)</span>, we don’t have to worry about controlling for <span class="math inline">\(Z\)</span> because <em>randomization is controlling for</em> <span class="math inline">\(Z\)</span> <em>now</em>. Rather than specifying <span class="math inline">\(Z\)</span> in a regression model, randomization is making sure that different values of <span class="math inline">\(Z\)</span> are balanced across those who get <span class="math inline">\(X\)</span> and those who don’t. This balancing property not only applies to <span class="math inline">\(Z\)</span> but also for <em>any</em> and <em>every</em> unknown/known confounder. Powerful stuff!</p>
<p>It is at this point in this blog post that we’re really going to let simulation shine and, if you’re not already familiar with simulation, I’m hoping this section will really help you see how powerful simulation is for science and statistics. The basic intuition for simulation is this: in the real world, we don’t know the causal effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>. We have to use tools to estimate the causal effect because the causal effect isn’t something that we can just mine for in the data. But, if we have to use tools to estimate causal effects, how do we know that the tools we use are <em>accurately estimating causal effects</em>? As stated before, the fundamental problem of causal inference states that we can’t ever observe all potential outcomes that we need. If that’s the case, how do we know that something like randomization actually works? We can’t use real data, because we don’t know the real effect in the real data (that’s the data we’re trying to infer causation from). However, we can use <em>simulated</em> data where we directly specify the causal effect in the simulated data itself. Once we know what this causal effect is, we can test our different tools to see how well our tools are able to capture the causal effect. <em>Simulating data gives us a tangible benchmark to evaluate the effectivness of models/research designs because no such benchmarks exist in real life data.</em> If our approach works on simulated data, then, assuming the assumptions of our approach hold in real life, the estimated causal effect using real world data should actually be the causal effect of interest.</p>
<p>In the code chunk below, we are going to use simulation to evaluate whether randomization can actually help us estimate causal effects. By this point, you know the logic of randomization, but does it actually work in practice? The code below involves simulating two data sets, each with 3000 observations. In the first data set, we are trying to estimate the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>, but this relationship is confounded by <span class="math inline">\(Z\)</span>. In the second data set, we are also trying to estimate the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> and <span class="math inline">\(X\)</span> is assigned totally at random, rather than being impacted by <span class="math inline">\(Z\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate Data Where X-Y Relationship is Confounded</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of Observations</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Confounder as a Continuous Variable</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Treatment as a Binary Variable That is Impacted by Z</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the Inverse Logit Function</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>prob_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="sc">-</span><span class="fl">2.5</span> <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> Z)))</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> prob_X)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Outcome with a Base Number to Start with (50), the Impact of X,</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># the Impact of Z, and Random Noise. The Estimated Effect of X Should Be 20</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">5</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine This Data</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Run a Biased Regression Model Omitting Z</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(Y <span class="sc">~</span> X, <span class="at">data =</span> sim_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y ~ X, data = sim_data)

Coefficients:
(Intercept)            X  
     287.69        44.19  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run a Regression Model Including Z</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(Y <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y ~ X + Z, data = sim_data)

Coefficients:
(Intercept)            X            Z  
     48.409       20.090        5.032  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate Data Where X-Y Relationship is Not Confounded Due to Randomization</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>X_random <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X_random) <span class="sc">+</span> (<span class="dv">5</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>sim_rando_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X_random</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Run a Regression Model with X Randomized</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(Y <span class="sc">~</span> X, <span class="at">data =</span> sim_rando_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y ~ X, data = sim_rando_data)

Coefficients:
(Intercept)            X  
      300.8         19.2  </code></pre>
</div>
</div>
<p>As you can see from the confounded data, when we run <code>lm(Y ~ X)</code>, our model’s estimated effect (44.19) is way off from estimating the actual effect (20). However, when we adjust for <span class="math inline">\(X\)</span>, we get the actual causal effect that we expect (20.1). That’s great, but remember this is a super simplified data set, where the X <span class="math inline">\(\rightarrow\)</span> Y relationship is only confounded by one confounder. In real life, this is never the case. Randomization can allegedly come to the rescue in such cases, but does our simulated exercise affirm this? Pretty much, yes, with an estimated effect of (19.2). Even though, in our randomized data, <span class="math inline">\(Z\)</span> still impacts <span class="math inline">\(Y\)</span>, we don’t need to control for <span class="math inline">\(Z\)</span> to estimate the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>. Keep in mind that these results are all generated from one random sample of 3000 observations. Naturally, the estimated unbiased effects (20.1 with regression adjustment and 19.2 with randomization) would change with each random sample a bit. If we ran this code 1000 times, drawing a different sample of 3000 observations each time, we would get closer to an average estimated effect of 20 for both methods. Basically, I wouldn’t read into the fact that neither estimates <em>exactly 20</em> too deeply.</p>
</section>
<section id="when-experiments-fall-short" class="level1">
<h1>When Experiments Fall Short</h1>
<p>So, randomization is great, and simulation is a cool way to evaluate which strategies work for causal inference. The bad news is that running randomized experiments are hard to pull off for three primary reasons. First, randomized experiments may be unethical. This one is pretty self-explanatory. Experimentation often involves real, living human beings, especially in the social sciences. Many questions in the social sciences revolve around harmful treatments (in this case, it might be better to refer to treatments as “exposures” since “harmful treatments” sounds weird). For example, we might ask, “what is the impact of food pantries on nutrition?” Something that would be very unethical is randomizing who gets access to food pantries. Some people would get access… and other wouldn’t, who might very much need that access.</p>
<p>Second, randomization may be impossible. This is something I am very familiar with, given my background in conflict research. There are all sorts of interesting questions in conflict research, but ask yourself how plausible any of these sound…. “What is the effect of democracy on civil conflict?”… Is a good researcher supposed to randomly assign which countries get to be democratic? Or, maybe you’re asking “What is the effect of civilian victimization during war on the prospects of post-conflict peace?”… Again, are researchers supposed to randomly assign atrocities against civilians? That’s not only impossible, but obviously, this is a bit of a double-dipper here since this idea is also pretty unethical!</p>
<p>Lastly, randomization may be unfeasible. There may be instances where randomization is neither morally wrong nor impossible. However, randomized experiments are still expensive and can take a lot of time. In many cases, lack of funding or lack of time may simply make a randomized experiment an unfeasible option. While randomization may represent an ideal approach, many restricted researchers may simply have to collect observational data. Again, the crucial distinction between observational data is that, unlike experimental data, the researcher is not in control of the treatment assignment mechanism. Units select into and/or are exposed to the treatment through means entirely outside of the researchers control.</p>
<p>When a researcher has to work with observational data and is interested in estimating causal effects, knowingly or unknowingly, they are operating under an <em>identification strategy</em> known as <em>selection on observables</em>. Okay so two new terms here. An identification strategy refers to a set of assumptions that, when met, allow one to identify a causal effect. I like to think of it like a fossil excavation. The fossil (causal effect) is in the ground (data) somewhere. But randomly chipping away at the earth isn’t going to get you the causal effect. You need to right tools for it (identification strategy). There are likely several tools you could use, but, given the material you’re working with and the fossil you’re trying to locate, you’ll need to adjust which toolkit you’ll end up using. Randomization is one identification strategy we could use, but the conditions need to be right for that identification strategy to be appropriate.</p>
<p>Selection on observables is a very popular, but also a very controversial identification strategy. Selection on observables operates under the assumption that those who received treatment (<span class="math inline">\(X_1\)</span>) and those who didn’t (<span class="math inline">\(X_0\)</span>) are different groups. For example, if <span class="math inline">\(X\)</span> is a hair loss medication, then <span class="math inline">\(X_1\)</span> may have a disproportionately higher number of men represented than in <span class="math inline">\(X_0\)</span>. Our goal for causal inference is to estimate counterfactuals so that we can take the difference between the factual and the counterfactual as the causal effect of interest. If <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_0\)</span> are fundamentally difference in relevant ways, then the difference between <span class="math inline">\(Y_1\)</span> (the outcome for those treated) and <span class="math inline">\(Y_0\)</span> (the outcome for those not treated) is not a valid counterfactual due to these differences. When we randomized <span class="math inline">\(X\)</span>, we could be sure that <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_0\)</span> are comparable due to the balancing properties of randomization. With observational data, <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_0\)</span> are almost guaranteed to be different in various ways.</p>
<p>Under selection on observables, <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_0\)</span> can be considered comparable, conditioned on a set of observable characteristics that we can adjust for. <em>This is what we do when we control for variables in regression models</em>. Going back to our very simple example with only one confounder, <span class="math inline">\(Z\)</span>, adjusting for <span class="math inline">\(Z\)</span> would make <span class="math inline">\(Y_{X_1}\)</span> minus <span class="math inline">\(Y_{X_0}\)</span> a valid factual minus counterfactual comparison to estimate a causal effect. Note that selection on observables doesn’t claim that, after adjusting for <span class="math inline">\(Z\)</span>, <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_0\)</span> are the same, it instead states that any remaining difference between <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_0\)</span> is <em>random</em> and, as the randomization section demonstrated, random “other things” that impact <span class="math inline">\(Y\)</span>, but not <span class="math inline">\(X\)</span>, are not things that need to be accounted for. So… all you need to do is identify the observables that make <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_0\)</span> different! And now, we run into our next problem…</p>
</section>
<section id="no-unobserved-confounding-and-sensitivity-analyses" class="level1">
<h1>No Unobserved Confounding and Sensitivity Analyses</h1>
<p>I’ve alluded to this problem earlier throughout this blog post, but the central problem with selection on observables is that we can never know if we’ve adjusted for <em>all</em> of the necessary observables. When I simulated data, I had control over how many confounding variables there were. So far, we’ve used a very simple framework, with just one confounder, <span class="math inline">\(Z\)</span>. Because I simulated the data, <em>I had the luxury of knowing how many confounders there were</em>. In the real world, we do not know how many confounders there are, and it’s <em>impossible</em> to 100% know if you’ve adjusted for all confounders. Don’t get me wrong, when operating under selection on observables, you do your best to identify as many confounders as you can (this is why DAGs are so useful) but, DAGs operate under <em>your</em> causal assumptions which may not reflect the reality of the world. Your assumptions may be wrong and assumed confounder <span class="math inline">\(Z\)</span> may not actually be a confounder. You may identify dozens of confounders, but there could be <em>another</em> confounder that you didn’t account for… and there’s no way to test for this. Plus, even <em>if</em> you did manage to identify all confounders (not that you would ever know if you did), you would need to 1) make sure that all confounders are measured correctly and 2) make sure you that you specify the functional form for each confounder correctly in a regression model.</p>
<p>To recap, absent randomization, you <em>still can theoretically</em> estimate causal effects. One alternative identification strategy to randomization is selection on observables where, post-confounder adjustment, the treated and control groups are comparable so that unbiased causal inference can take place. However, the researcher is in charge of identifying, measuring, and correctly specifying these confounders, which involves a lot of theory and subjectivity. Given <em>all of this room for error</em>, selection on observables is not considered to be a strong identification strategy, and many rely on it only as a last resort when randomization or other rare identification strategies are not available options. That’s a bummer. Are researchers using selection on observables just supposed to tell the audience “trust me” when it comes to control variable selection and the quality/reliability of their causal inferences?</p>
<p>Well, this <em>de facto</em> is the case in most published selection on observables papers. Sure, scholars make <em>very brief</em> justifications for why they include certain control variables (importantly, a lot of these justifications boil down to “that’s the variable we’ve always controlled for”… PSA: don’t do that!). But most of the time, it doesn’t go beyond that very much. This is why many researchers acknowledge that making causal inferences from observational research designs isn’t always the best practice. Despite this acknowledgement, many researchers engage in such inferences by substituting the word “cause” for “impact”, “effect”, etc. which equally imply causation (don’t do that either!).</p>
<p>So, do you just give up on trying to make causal inferences at this point? While you can’t test for whether you’re missing a confounder, you <em>can</em> test for what impact a <em>hypothetical</em> missing confounder would have on your analysis if it was omitted. This sort of test is referred to as a <em>sensitivity analysis</em> because we are testing how sensitive our estimate is to various hypothetical levels of unobserved confounding. Sensitivity analyses are incredibly valuable tools for causal inference because, while they don’t tell us whether we <em>met the required assumptions to make causal inferences</em>, they can tell us <em>how much our estimate would change if we violated the necessary identification assumptions to varying degrees</em>. From this, we can still provide pretty compelling causal evidence if our estimate is robust to various hypothetical identification assumption violations. Alternatively, if our estimate changes <em>a lot</em> due to relatively small identifying assumption violations, this would tell us that, assuming these violations are likely (which, when dealing with confounders, it’s probably a good idea to assume that you are missing some confounders, even if their confounding effect is small), our research design is not able to provide sufficient evidence that our estimate of the causal effect of <span class="math inline">\(X\)</span> is the true causal effect.</p>
<p>Again, simulation is a very valuable tool here to help us understand the intuition behind sensitivity analyses. In the following syntax, we keep most of the structure of the initial simulated data, with a specified effect size of 20. Then, we simulate 10 different confounders that have varying effect sizes on <span class="math inline">\(Y\)</span> starting from 0.25x the size of 20 and then going up in 0.25-increments to 2.5x 20. Once this is done, I am running 20 linear regressions; 2 for each confounder with 1 specfying the confounder in the regression model and the other omitting the confounder.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate Data Where X-Y Relationship is Confounded</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of Observations</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Confounder</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate The Treatment That is Impacted by the Confounder</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>prob_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="sc">-</span><span class="fl">2.5</span> <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> Z)))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> prob_X)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate 10 Outcomes That Are Affected by Different Confounders</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>Y_1 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">5</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="co"># Z is 1/4 X</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>Y_2 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">10</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="co"># Z is 1/2 X</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>Y_3 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">15</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="co"># Z is 3/4 X</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>Y_4 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="co"># Z = X</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>Y_5 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">25</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="co"># Z is 1.25x X</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>Y_6 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">30</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="co"># Z is 1.5x X</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>Y_7 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">35</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="co"># Z is 1.75x X</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>Y_8 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">40</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="co"># Z is 2x X</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>Y_9 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">45</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="co"># Z is 2.25x X</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>Y_10 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">50</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) <span class="co"># Z is 2.5x X</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine This Data</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_1 =</span> Y_1,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_2 =</span> Y_2,</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_3 =</span> Y_3,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_4 =</span> Y_4,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_5 =</span> Y_5,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_6 =</span> Y_6,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_7 =</span> Y_7,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_8 =</span> Y_8,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_9 =</span> Y_9,</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_10 =</span> Y_10,</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 10 Biased and 10 Unbiased Regression Models</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_1 <span class="sc">~</span> X, <span class="at">data =</span> sim_data),</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_2 <span class="sc">~</span> X, <span class="at">data =</span> sim_data),</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_3 <span class="sc">~</span> X, <span class="at">data =</span> sim_data),</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_4 <span class="sc">~</span> X, <span class="at">data =</span> sim_data),</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_5 <span class="sc">~</span> X, <span class="at">data =</span> sim_data),</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_6 <span class="sc">~</span> X, <span class="at">data =</span> sim_data),</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_7 <span class="sc">~</span> X, <span class="at">data =</span> sim_data),</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_8 <span class="sc">~</span> X, <span class="at">data =</span> sim_data),</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_9 <span class="sc">~</span> X, <span class="at">data =</span> sim_data),</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_10 <span class="sc">~</span> X, <span class="at">data =</span> sim_data),</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_1 <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data),</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_2 <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data),</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_3 <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data),</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_4 <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data),</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_5 <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data),</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_6 <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data),</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_7 <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data),</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_8 <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data),</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_9 <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data),</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(Y_10 <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data)</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>bias <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">confounder_size =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="fl">0.25</span>, <span class="at">by =</span> <span class="fl">0.25</span>, <span class="at">length.out =</span> <span class="dv">10</span>), <span class="at">length.out =</span> <span class="fu">length</span>(models)),</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">bias =</span> <span class="fu">sapply</span>(models, <span class="cf">function</span>(mod) <span class="fu">coef</span>(mod)[<span class="st">"X"</span>] <span class="sc">-</span> <span class="dv">20</span>)</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">z_omit =</span> <span class="fu">ifelse</span>(<span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="dv">10</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span>)</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now, we can visualize the results of this sensitivity analysis. As you can see in the plot below, when the magnitude of a confounder gets bigger, the bias in our estimate also does and we start making very bad causal inferences. Note: there’s a lot of room for more complex stuff to do. You can do a sensitivity analysis where you examine the magnitude of the confounder relative to its effect on the <em>treatment</em> rather than the outcome. Or… you can simulate tons of confounders that have varying effects on both the treatment and outcome. What about more than just one confounder? That’s something else to think about. Also, things get more complicated when you depart from linear regression and start dealing with logit, Poisson, duration models, etc. so keep that in mind as well. Thankfully, other people have already done the hard work and have developed packages to execute sensitivity analyses for GLMs (such as <a href="https://livefreeordichotomize.com/posts/2022-09-07-tipr-an-r-package-for-sensitivity-to-unmeasured-confounding/">tipr</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>bias <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> confounder_size, <span class="at">y =</span> bias, <span class="at">color =</span> z_omit)) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fl">0.25</span>, <span class="fl">2.5</span>, <span class="at">by =</span> <span class="fl">0.25</span>)) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Yes"</span> <span class="ot">=</span> <span class="st">"#e31837"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>               <span class="st">"No"</span> <span class="ot">=</span> <span class="st">"#003594"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">""</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Size of Hypothetical Missing Confounder Relative to Treatment Effect"</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Bias (Estimated Effect - True Effect)"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Is Z Omitted</span><span class="sc">\n</span><span class="st">From the Model?"</span>) <span class="sc">+</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">blog_theme</span>() <span class="sc">+</span> </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>), </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)  </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/plot sensitivity analysis-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Unobserved Confounder Sensitivity Analysis</figcaption>
</figure>
</div>
</div>
</div>
<p>Importantly, whether or not such a large confounder exists is something that is also - you guessed it - not testable. This is where it is so important to rely on theory and domain knowledge to evaluate whether such a hypothetical, unobserved confounder is possible. After all, the bias is huge in this case when a confounder that has 2.5x the effect of <span class="math inline">\(X\)</span> is omitted from the analysis. But you only need to worry about that if it’s plausible that such a large confounder exists.</p>
<p>As a final note before moving on to the next section, I have made the point that, if you are operating under selection on observables, you need to makes sure there is no unobserved/unmeasured confounding. That is a very simple way to state this assumption, but, you will find this assumption expressed in <em>tons</em> of different ways such as ignorability, exchangeability, conditional independence, strict exogeneity, etc. Don’t be scared by these terms! While I suggest going through the logic of each assumption, what’s important to remember is that, whatever you call it, you need to make sure there is no unmeasured confounding if you want to make causal inferences!</p>
</section>
<section id="dont-be-a-control-freak-overadjustment-bias" class="level1">
<h1>Don’t Be a Control Freak! Overadjustment Bias</h1>
<p>Because you want to make sure there is no unmeasured confounding, you might be tempted to control for as many variables as possible “just to be sure”. <strong>Don’t be a control freak!</strong> This idea of controlling for as much as possible is a bad idea, not only because it can stretch the statistical capabilities of your model, but also because controlling for <em>certain types of variables</em> can <em>harm</em> your effort to make causal inferences. In this section, we are going to go through 4 types of variables that are a bit different from the three we have been discussing so far (treatment, outcome, and confounders).</p>
<section id="mediators" class="level2">
<h2 class="anchored" data-anchor-id="mediators">Mediators</h2>
<p>The first type of variable that we want to avoid controlling for is the mediator. A mediator is any variable that is, in part caused by <span class="math inline">\(X\)</span> which then, in part, causes a change in <span class="math inline">\(Y\)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set Up the DAG</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>simple_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> Z <span class="sc">+</span> X <span class="sc">+</span> M,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> Z,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  M <span class="sc">~</span> X,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">"X"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">7</span>, <span class="at">X =</span> <span class="dv">4</span>, <span class="at">Z =</span> <span class="fl">5.5</span>, <span class="at">M =</span> <span class="fl">5.5</span>),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">2</span>, <span class="at">X =</span> <span class="dv">2</span>, <span class="at">Z =</span> <span class="dv">3</span>, <span class="at">M =</span> <span class="fl">1.5</span>)),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="st">"Y"</span>, <span class="at">X =</span> <span class="st">"X"</span>, <span class="at">Z =</span> <span class="st">"Z"</span>, <span class="at">M =</span> <span class="st">"M"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert DAG to a Tidy Object for Plotting</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>simple_dag_tidy <span class="ot">&lt;-</span> simple_dag <span class="sc">%&gt;%</span> </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">case_when</span>(</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"X"</span> <span class="sc">~</span> <span class="st">"exposure"</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"Y"</span> <span class="sc">~</span> <span class="st">"outcome"</span>,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"M"</span> <span class="sc">~</span> <span class="st">"mediator"</span>,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"other"</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>status_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">exposure =</span> <span class="st">"#6f1a1a"</span>, <span class="at">outcome =</span> <span class="st">"#384d35"</span>, <span class="at">mediator =</span> <span class="st">"#7d8d67"</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Plot</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simple_dag_tidy, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> status)) <span class="sc">+</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> label, <span class="at">fill =</span> status),</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">nudge_y =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>, <span class="at">fill =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>DAG Incluing a Mediator</figcaption>
</figure>
</div>
</div>
</div>
<p>Controlling for a mediator should be avoided because, if we control for it, our estimated effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> will be a deflated version of the causal effect of interest because controlling for the mediator effectively removes the part of the causal effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> that is mediated through <span class="math inline">\(M\)</span>. We can see this clearly with the following simulated regressions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate Data Where X-Y Relationship is Confounded</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of Observations</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Confounder as a Continuous Variable</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Treatment as a Binary Variable That is Impacted by Z</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the Inverse Logit Function</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>prob_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="sc">-</span><span class="fl">2.5</span> <span class="sc">+</span> (<span class="fl">0.05</span><span class="sc">*</span>Z))))</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> prob_X)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate a Mediator That is Impacted by X</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> (<span class="dv">10</span><span class="sc">*</span>X) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Outcome with a Base Number to Start with (50), the Impact of X,</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># the Impact of Z, the Impact of M Mediated by X, and Random Noise. The Estimated Total Effect of X Should Be 30</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> ((<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> M) <span class="sc">+</span> (<span class="dv">5</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine This Data</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">M =</span> M,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Run a Biased Model Where the Mediator is Included </span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X <span class="sc">+</span> Z <span class="sc">+</span> M, <span class="at">data =</span> sim_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y ~ X + Z + M, data = sim_data)

Residuals:
    Min      1Q  Median      3Q     Max 
-33.299  -6.454  -0.020   6.449  33.509 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 50.08945    0.91749   54.59   &lt;2e-16 ***
X           20.17165    0.41190   48.97   &lt;2e-16 ***
Z            5.00013    0.01851  270.16   &lt;2e-16 ***
M            0.98048    0.01810   54.18   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 9.805 on 2996 degrees of freedom
Multiple R-squared:  0.9708,    Adjusted R-squared:  0.9708 
F-statistic: 3.325e+04 on 3 and 2996 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run an Unbiased Model Where the Mediator is Excluded</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y ~ X + Z, data = sim_data)

Residuals:
    Min      1Q  Median      3Q     Max 
-52.431  -9.296   0.177   9.374  45.548 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 48.52958    1.29011   37.62   &lt;2e-16 ***
X           30.06503    0.51941   57.88   &lt;2e-16 ***
Z            5.03174    0.02602  193.35   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 13.79 on 2997 degrees of freedom
Multiple R-squared:  0.9423,    Adjusted R-squared:  0.9422 
F-statistic: 2.446e+04 on 2 and 2997 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Note that, in this blog post, <span class="math inline">\(X\)</span> = 20 is the sort of unbiased causal effect we have been looking for so far. However, I’ve modified that a bit here because our mediator contributes to the causal effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>. In reality, our causal effect of <span class="math inline">\(X\)</span> should be the direct effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> (20) but it should also include the total effect that is mediated through <span class="math inline">\(M\)</span> (10). In the first model, we see our direct effect is correct, but we are not attempting to estimate the direct effect. The direct effect is accurate because we are controlling for our mediator <em>and our mediator is not confounded</em>. That’s right… if you <em>want</em> to work with a mediator to estimate direct and indirect effects (this practice is referred to as mediation analysis) of <span class="math inline">\(X\)</span> and <span class="math inline">\(M\)</span> on <span class="math inline">\(Y\)</span>, you’ve doubled the challenge of dealing with confounding because, not only do you have to make sure that <span class="math inline">\(X\)</span> <span class="math inline">\(\rightarrow\)</span> <span class="math inline">\(Y\)</span> is unconfounded, you also have to make sure that <span class="math inline">\(M\)</span> <span class="math inline">\(\rightarrow\)</span> <span class="math inline">\(Y\)</span> is <em>also</em> unconfounded. This is a major reason behind the skepticism for mediation analyses. Regardless, as you can see in the second model where <span class="math inline">\(M\)</span> is excluded, we get the correct total effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>, which includes the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> and the effect of <span class="math inline">\(M\)</span> on <span class="math inline">\(Y\)</span> that is caused by <span class="math inline">\(X\)</span>.</p>
</section>
<section id="colliders" class="level2">
<h2 class="anchored" data-anchor-id="colliders">Colliders</h2>
<p>Colliders are interesting because they are very sneaky. I like to think of them as inverse confounders. You <em>need</em> to control for a confounder (<span class="math inline">\(X\)</span> <span class="math inline">\(\leftarrow\)</span> <span class="math inline">\(Z\)</span> <span class="math inline">\(\rightarrow\)</span> <span class="math inline">\(Y\)</span>) but you should <em>not</em> control for a collider (<span class="math inline">\(X\)</span> <span class="math inline">\(\rightarrow\)</span> <span class="math inline">\(C\)</span> <span class="math inline">\(\leftarrow\)</span> <span class="math inline">\(Y\)</span>). The crucial difference here is the causal ordering of the third variable as it relates to the treatment and outcome. Whereas a confounder is a common cause of <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, a collider is a common <em>consequence</em> of <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>. In the following DAG, note that I am not positing that <span class="math inline">\(X\)</span> impacts <span class="math inline">\(Y\)</span>. This is intentional.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set Up the DAG</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>simple_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> Z,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> Z,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  C <span class="sc">~</span> X <span class="sc">+</span> Y,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">"X"</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">7</span>, <span class="at">X =</span> <span class="dv">4</span>, <span class="at">Z =</span> <span class="fl">5.5</span>, <span class="at">C =</span> <span class="fl">5.5</span>),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">2</span>, <span class="at">X =</span> <span class="dv">2</span>, <span class="at">Z =</span> <span class="dv">3</span>, <span class="at">C =</span> <span class="fl">1.5</span>)),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="st">"Y"</span>, <span class="at">X =</span> <span class="st">"X"</span>, <span class="at">Z =</span> <span class="st">"Z"</span>, <span class="at">C =</span> <span class="st">"C"</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert DAG to a Tidy Object for Plotting</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>simple_dag_tidy <span class="ot">&lt;-</span> simple_dag <span class="sc">%&gt;%</span> </span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">case_when</span>(</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"X"</span> <span class="sc">~</span> <span class="st">"exposure"</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"Y"</span> <span class="sc">~</span> <span class="st">"outcome"</span>,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"C"</span> <span class="sc">~</span> <span class="st">"collider"</span>,</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"other"</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>status_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">exposure =</span> <span class="st">"#6f1a1a"</span>, <span class="at">outcome =</span> <span class="st">"#384d35"</span>, <span class="at">collider =</span> <span class="st">"#ec9b00"</span>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Plot</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simple_dag_tidy, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> status)) <span class="sc">+</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> label, <span class="at">fill =</span> status),</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">nudge_y =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>, <span class="at">fill =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>DAG Incluing a Collider</figcaption>
</figure>
</div>
</div>
</div>
<p>Why does controlling for a common consequence of treatment and outcome lead to problems? Because it can suggest a spurious association between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>. In other words, controlling for a collider can create an association between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> that does not reflect a causal relationship. This is why I like to think of colliders as inverse confounders. By default, confounders create spurious associations between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, and we combat this and remove the spurious association to make causal inferences by controlling for the confounder. In contrast, we can <em>introduce</em> spurious associations as well by controlling for certain variables; common causes.</p>
<p>But this is still vague… What is a hypothetical example of this? To keep thing’s grounded, I’ll borrow an example from <a href="https://journals.sagepub.com/doi/pdf/10.1177/2515245917745629">Rohrer 2018</a>. On a particularly lonely day, an individual may be reminiscing on their former romantic partners. They start thinking about the traits of their former romantic partners, and they begin to notice that their more attractive partners were less intelligent than their comparatively less attractive partners. (In DAG terms, this individual is considering whether Attractiveness <span class="math inline">\(\rightarrow\)</span> Intelligence). Should this person conclude that, among all potential partners, the more attractive they are, the less intelligent they will be? No! Because this observation is conditioned on a <em>collider</em>. And that collider is <em>the fact they have dated the subjects</em>. Most people are attracted to physically attractive and intelligent people, so whether or not this individual has dated someone is likely influenced by their attractiveness and intelligence (Attractiveness <span class="math inline">\(\rightarrow\)</span> Dated <span class="math inline">\(\leftarrow\)</span> Intelligence). We can clearly see that whether or not this individual has dated someone is a collider. By just looking at their former partners, they are introducing a spurious association between physical attraction and intelligence.</p>
<p>Okay but, among this subset of people, the individual still finds a negative association between physical attraction and intelligence. Maybe it’s not fair to generalize this relationship to the broader dating pool, but how does that explain this individual’s former partners? We can explain this with a couple of reasons. First, it is rare that this individual could <em>find</em> someone else who is both highly attractive and highly intelligent. Even if they could, that person would likely already be taken. Second, this individual is probably unlikely to date someone who is also <em>low</em> in both physical attraction and intelligence. As a result, their former partners varied in both intelligence and physical attraction. Sometimes, a partner was more attractive, but not equally intelligent. At other times, a partner was more intelligent, but not as physically attractive. If this person would not have developed their conclusion based on their prior dating experiences (this is equivalent to controlling for people they have previously dated), they likely would not have found that this negative relationship holds up. In a very roundabout way, we have also described a type of selection bias here. By conditioning on a collider, we are limiting our analysis to a subset of cases that are impacted by treatment and outcome. This serves to bias our analysis and create associations that some might interpret as causal while no such association actually exists. This issue does not become a problem if you simply don’t control for a collider.</p>
<p>Let’s put this into practice using simulation. In contrast to the mediator example, I am not going to simulate a relationship between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>. If our model estimates such a relationship, there is a problem.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate Data with No X-Y Relationship</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of Observations</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Confounder as a Continuous Variable</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Treatment as a Binary Variable That is Impacted by Z</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the Inverse Logit Function</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>prob_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="sc">-</span><span class="fl">2.5</span> <span class="sc">+</span> (<span class="fl">0.05</span><span class="sc">*</span>Z))))</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> prob_X)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Outcome with a Base Number to Start with (50), </span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co"># the Impact of Z, and Random Noise. </span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">5</span><span class="sc">*</span>Z) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate a Collider</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> (<span class="dv">10</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">10</span><span class="sc">*</span>Y) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine This Data</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">C =</span> C,</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Run a Biased Model Including the Collider</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X <span class="sc">+</span> Z <span class="sc">+</span> C, <span class="at">data =</span> sim_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y ~ X + Z + C, data = sim_data)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.3454 -0.6454  0.0037  0.6414  3.3643 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.3664761  0.1262877   2.902  0.00374 ** 
X           -0.9889660  0.0368645 -26.827  &lt; 2e-16 ***
Z            0.0393890  0.0092391   4.263 2.08e-05 ***
C            0.0992183  0.0001799 551.507  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.9776 on 2996 degrees of freedom
Multiple R-squared:  0.9996,    Adjusted R-squared:  0.9996 
F-statistic: 2.735e+06 on 3 and 2996 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run an Unbiased Model Excluding the Collider</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y ~ X + Z, data = sim_data)

Residuals:
    Min      1Q  Median      3Q     Max 
-31.885  -6.900  -0.085   6.837  36.475 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 48.40907    0.92564  52.298   &lt;2e-16 ***
X            0.09033    0.37268   0.242    0.808    
Z            5.03224    0.01867 269.502   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 9.897 on 2997 degrees of freedom
Multiple R-squared:  0.9626,    Adjusted R-squared:  0.9626 
F-statistic: 3.855e+04 on 2 and 2997 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>As you can see, when I controlled for the collider, a truly non-existent relationship between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> shows up. In contrast, when <span class="math inline">\(C\)</span> is omitted, we don’t observe an effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> which, in this case, is true! Beware colliders, folks, and think carefully before you control for a variable.</p>
</section>
<section id="ancestors-of-outcome-and-treatment" class="level2">
<h2 class="anchored" data-anchor-id="ancestors-of-outcome-and-treatment">Ancestors of Outcome and Treatment</h2>
<p>Lastly, we get to the ancestors. These types of variables are interesting because they are very common and you could identify a lot of them, but you <em>don’t</em> have to control for any of them. And, if you <em>do</em> control for them, it might not be a huge deal. Why is this the case? After all, there seemed to be pretty major consequences when controlling for a mediator/collider?</p>
<p>As you can see in the DAG below, we have two types of ancestors. An ancestor of <span class="math inline">\(X\)</span> and an ancestor of <span class="math inline">\(Y\)</span>. Each of these impact their respective node, but are otherwise unconnected to other nodes in the DAG. Because neither is related to <em>both</em> <span class="math inline">\(X\)</span> <em>and</em> <span class="math inline">\(Y\)</span>, controlling/not controlling for these should not impact the <em>causal</em> interpretation of your estimate… with a couple of caveats.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set Up the DAG</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>simple_dag <span class="ot">&lt;-</span> <span class="fu">dagify</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  Y <span class="sc">~</span> Z <span class="sc">+</span> X <span class="sc">+</span> AY,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> Z <span class="sc">+</span> AX,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">exposure =</span> <span class="st">"X"</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">7</span>, <span class="at">X =</span> <span class="dv">4</span>, <span class="at">Z =</span> <span class="fl">5.5</span>, <span class="at">AX =</span> <span class="fl">3.25</span>, <span class="at">AY =</span> <span class="fl">7.75</span>),</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="dv">2</span>, <span class="at">X =</span> <span class="dv">2</span>, <span class="at">Z =</span> <span class="dv">3</span>, <span class="at">AX =</span> <span class="fl">2.5</span>, <span class="at">AY =</span> <span class="fl">2.5</span>)),</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="at">Y =</span> <span class="st">"Y"</span>, <span class="at">X =</span> <span class="st">"X"</span>, <span class="at">Z =</span> <span class="st">"Z"</span>, <span class="at">AX =</span> <span class="st">"AX"</span>, <span class="at">AY =</span> <span class="st">"AY"</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert DAG to a Tidy Object for Plotting</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>simple_dag_tidy <span class="ot">&lt;-</span> simple_dag <span class="sc">%&gt;%</span> </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> <span class="fu">case_when</span>(</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"X"</span> <span class="sc">~</span> <span class="st">"exposure"</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"Y"</span> <span class="sc">~</span> <span class="st">"outcome"</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"AX"</span> <span class="sc">~</span> <span class="st">"ax"</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"AY"</span> <span class="sc">~</span> <span class="st">"ay"</span>,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"other"</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>status_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">exposure =</span> <span class="st">"#6f1a1a"</span>, <span class="at">outcome =</span> <span class="st">"#384d35"</span>, <span class="at">ax =</span> <span class="st">"#a32b2b"</span>, <span class="at">ay =</span> <span class="st">"#597657"</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Plot</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simple_dag_tidy, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> status)) <span class="sc">+</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> label, <span class="at">fill =</span> status),</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">nudge_y =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> status_colors, <span class="at">na.value =</span> <span class="st">"grey20"</span>) <span class="sc">+</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>, <span class="at">fill =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>DAG Incluing Ancestors of Treatment and Outcome</figcaption>
</figure>
</div>
</div>
</div>
<p>To demonstrate, I am simply simulating a variable that causes a change in <span class="math inline">\(X\)</span> (<span class="math inline">\(AX\)</span>) and a variable that causes a change in <span class="math inline">\(Y\)</span> (<span class="math inline">\(AY\)</span>)… and that’s all that these variables do. Then, I run a regression controlling for neither, and a respective regression controlling for each. Let’s see what we get.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate Data Where X-Y Relationship is Confounded</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of Observations</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Confounder as a Continuous Variable</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate Ancestors of Treatment/Outcome</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>AX <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">10</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>AY <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">10</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Treatment as a Binary Variable That is Impacted by Z and AX</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the Inverse Logit Function</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>prob_X <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="sc">-</span><span class="fl">2.5</span> <span class="sc">+</span> (<span class="fl">0.05</span><span class="sc">*</span>Z) <span class="sc">+</span> (<span class="fl">0.1</span><span class="sc">*</span>AX))))</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> prob_X)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the Outcome with a Base Number to Start with (50), the Impact of X,</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co"># the Impact of Z, the Impact of AY, and Random Noise. The Estimated Effect of X Should Be 20</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> (<span class="dv">20</span><span class="sc">*</span>X) <span class="sc">+</span> (<span class="dv">5</span><span class="sc">*</span>Z) <span class="sc">+</span> (<span class="dv">2</span><span class="sc">*</span>AY) <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">10</span>) </span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine This Data</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y,</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">AX =</span> AX,</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">AY =</span> AY</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Run a Regression Omitting Both the Ancestor of Treatment and Ancestor of Outcome</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X <span class="sc">+</span> Z, <span class="at">data =</span> sim_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y ~ X + Z, data = sim_data)

Residuals:
    Min      1Q  Median      3Q     Max 
-76.469 -14.940   0.352  14.707  83.582 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 70.43861    2.08184   33.84   &lt;2e-16 ***
X           18.82075    0.89826   20.95   &lt;2e-16 ***
Z            5.01715    0.04171  120.28   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 22.21 on 2997 degrees of freedom
Multiple R-squared:  0.849, Adjusted R-squared:  0.8489 
F-statistic:  8426 on 2 and 2997 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run a Regression Only Including the Ancestor of Treatment</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X <span class="sc">+</span> Z <span class="sc">+</span> AX, <span class="at">data =</span> sim_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y ~ X + Z + AX, data = sim_data)

Residuals:
    Min      1Q  Median      3Q     Max 
-75.912 -15.042   0.284  14.718  83.053 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 70.87527    2.11189  33.560   &lt;2e-16 ***
X           19.26880    0.96962  19.873   &lt;2e-16 ***
Z            5.01320    0.04183 119.834   &lt;2e-16 ***
AX          -0.05481    0.04468  -1.227     0.22    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 22.21 on 2996 degrees of freedom
Multiple R-squared:  0.8491,    Adjusted R-squared:  0.8489 
F-statistic:  5619 on 3 and 2996 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run a Regression Only Including the Ancestor of Outcome</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X <span class="sc">+</span> Z <span class="sc">+</span> AY, <span class="at">data =</span> sim_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y ~ X + Z + AY, data = sim_data)

Residuals:
    Min      1Q  Median      3Q     Max 
-39.969  -6.847   0.187   6.650  36.293 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 49.81184    0.95232   52.31   &lt;2e-16 ***
X           19.75974    0.40282   49.05   &lt;2e-16 ***
Z            5.00853    0.01870  267.80   &lt;2e-16 ***
AY           1.99510    0.01828  109.15   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 9.957 on 2996 degrees of freedom
Multiple R-squared:  0.9697,    Adjusted R-squared:  0.9696 
F-statistic: 3.192e+04 on 3 and 2996 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>When neither ancestor is included, we get pretty close to the actual treatment size. Similarly, when either ancestor is included, the estimated effect doesn’t change much and is pretty unbiased. So, what changed? Check out the standard errors! Without controlling for either ancestor, the standard error for the <span class="math inline">\(X\)</span> estimate is 0.9. However, when we control for <span class="math inline">\(AX\)</span>, that standard error gets a bit bigger (0.97). In contrast, when we control for <span class="math inline">\(AY\)</span>, the standard error shrinks all the way down to 0.4. While controlling for either did not impact our causal effect estimate, including these variables did have an impact on the <em>precision</em> of our estimate. In other words, they respectively increased/decreased statistical uncertainty regarding whether these effect are statistically different from 0. In all cases, the estimated effect of <span class="math inline">\(X\)</span> was still statistically significant, but that is likely due to how simple my simulated data are.</p>
<p>So what are those two caveats that I briefly mentioned a second ago. First, don’t always think of <span class="math inline">\(AX\)</span> being bad. As a general rule, you probably should not control for <span class="math inline">\(AX\)</span>, but you should think about what your ancestors of treatment are. If, as I simulated, your ancestor of treatment <em>only</em> impacts <span class="math inline">\(Y\)</span> through <span class="math inline">\(X\)</span> and is totally unrelated to any other node in your DAG, you probably have an <em>instrument</em> which is a whole other can of worms that I won’t open here but basically, the TLDR is that you <em>can</em> use this instrument as a form of randomization… Long story but this is where instrumental variables designs are relevant. Although, another caveat is warranted here because identifying actual instruments is very, very hard in practice.</p>
<p>The second caveat is one that confuses me. Notice how I made the effect size of <span class="math inline">\(AY\)</span> so small compared to all of the other effect sizes we have been working with thus far? Well, I did that because making <span class="math inline">\(AY\)</span> large (as ancestors of outcome will often be in practice) really screwed up results and made the estimate for <span class="math inline">\(X\)</span> very biased (like, down in the 13-16 range). I don’t know why this is the case. Theoretically, <span class="math inline">\(AY\)</span> has nothing to do with <span class="math inline">\(X\)</span>, so including it should not impact the estimate for <span class="math inline">\(X\)</span>. Nonetheless, it did and I do not fully understand why. I don’t think I’ve discovered something novel… in reality, something is going on in the math behind the simulation that I’m sure I’m not understanding. Regardless, controlling for ancestors of outcome often results in increase to statistical precision, so it’s not like its the end of the world to <em>have</em> to control for <span class="math inline">\(AY\)</span>.</p>
</section>
</section>
<section id="positivity-and-treatment-effects" class="level1">
<h1>Positivity and Treatment Effects</h1>
<p>So far, we have thrown the word “effect” around pretty loosely (and I will do so for the remainder of this blog out of convenience, but that should not be your approach in serious academic/industry settings). The liberal application of this word is likewise employed in academic studies. This is not good practice. When we state an estimated effect, we should also specify <em>to whom that effect applies</em>. Yes, you can control for the appropriate variables and avoid controlling for the inappropriate variables, but this does not ensure that your estimated effect applies to all units in your sample.</p>
<p>Again, to understand this, we need to reference counterfactuals again. When we make causal inferences, we assume that, within our data, there is some unit that serves as a valid counterfactual of the other. With a randomized control experiment, randomization ensures that each group serves as a valid counterfactual of the other. That is, the treated group serves as a counterfactual to the control group and vice versa. This is ensured by the property of randomization where, on average, each group is the same in every relevant aspect. Because each group serves as the other’s counterfactual, the estimated effect in a randomized experiment is known as the average treatment effect (ATE). The ATE tells us the estimated effect of treatment when every unit in a population takes treatment v. when nobody in a population takes treatment.</p>
<p>However, when we can’t do randomization of treatment, estimating the ATE may not be feasible. We may be able to remove confounding under selection on observables, but this does not ensure that, post-confounding adjustment, all treated units are comparable to all control units. We can demonstrate this with a simple example. Suppose that we want to estimate the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>, which is only confounded by <span class="math inline">\(Z\)</span>. We adjust for <span class="math inline">\(Z\)</span> to remove that source of confounding, but we have a problem. The distribution of <span class="math inline">\(Z\)</span> for the treated units (<span class="math inline">\(X_1\)</span>) ranges from 5-15. In contrast, the distribution of <span class="math inline">\(Z\)</span> for the control units (<span class="math inline">\(X_0\)</span>) ranges from 5-20. What’s the significance here? Well, there’s clearly comparable values for each treated unit in the control population. <span class="math inline">\(X_1\)</span> ranges from 5-15, so we can find similar <span class="math inline">\(Z\)</span> values in <span class="math inline">\(X_0\)</span> because the values of <span class="math inline">\(Z\)</span> in <span class="math inline">\(X_0\)</span> range from 5-20. However, there are no <span class="math inline">\(Z\)</span> values in <span class="math inline">\(X_1\)</span> that exceed 15. Therefore, the control units whose <span class="math inline">\(Z\)</span> value are greater than 15 do not have a valid treated unit to serve as a counterfactual. What is to be done?</p>
<p>Well, that means you can’t estimate the ATE anymore, because your treated and control groups aren’t 100% comparable across the entire confounder distribution. We can estimate the treatment effect for the treated (this is known as the “average treatment effect for the treated” - ATT) because we have “common support” in <span class="math inline">\(X_0\)</span> so that each unit in <span class="math inline">\(X_1\)</span> has a counterfactual unit to make causal inferences for the treated units. So, it’s not the end of the world, we just have to adjust the <em>estimand</em> that we sought to <em>estimate</em>. No, that was not a typo. An estimand is something different from an estimate. The estimand is the thing we are trying to estimate. For example, in a randomized experiment, our estimand might be the ATE, and our estimated effect from our trial is the <em>estimate</em>. The estimand is something real that exists in the universe. The estimate is our scientific attempt to discover the estimand.</p>
<p>When our data does not contain sufficient units to serve as valid counterfactuals for our desired estimand (say, for example, that we wanted to estimate the ATE), then we have violated the positivity assumption, which states that there is a non-zero chance that every unit across every combination of confounders receives any treatment values. That’s a mouthful, but the idea is fairly simple. If treatment is only 2 values, then, across every possible combination of confounder values, <span class="math inline">\(Pr(X) = 1 &gt; 0\)</span>. When we violate this, we need to update what estimand we can attempt to estimate.</p>
<p>Okay, so again, this all might seem a bit esoteric because the language gets muddy quick, but I promise it’s pretty simple. I’m going to try and demonstrate this visually. Assume that I’ve collected data on 3000 units and I’ve identified several confounders that I need to adjust for to estimate the causal effect of a binary treatment. I want to estimate the ATT (the effect of treatment for units that were treated) and I need to check and see if this is feasible. Under the positivity assumption, every possible combination of values across all confounders for the treated units should have a control unit just like it who only differs with respect to treatment status. To make things super simple, assume that we have adjusted for 10 confounders and all confounders are binary. To make things even simpler, let’s imagine one hypothetical treated unit whose confounder values are {1, 0, 0, 1, 1, 0, 0, 0, 1, 0}. If one control unit has confounder values who are also {1, 0, 0, 1, 1, 0, 0, 0, 1, 0}, then, for this specific unit, we have common support. If this hold across the distribution of <em>all</em> your treated units, then you <em>can</em> estimate the ATT.</p>
<p>However, assuming all of your confounders are nice and easy dummy variables is too simplistic. Let’s instead imagine that we use the confounders to predict the probability of being treated for treated and control units to simplify the multi-dimensional problem of visualizing every possible combination of 10 confounders. This way, we can plot the probability of treatment on a two-dimensional space (that’s certainly easier than plotting a 10-dimensional figure). The following three distribution plots are going to plot data where three different estimands are appropriate, the ATE, the ATT, and the ATC (the average treatment effect of the control units… this is sometimes known as the ATU - the average treatment effect for the un-treated).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Identical Treatment Probabilities for Treated and Control Groups</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume That These Probabilities Derive From Confounders</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>pr_treatment_X1 <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="fl">0.5</span>, <span class="at">sd =</span> <span class="fl">0.15</span>), <span class="dv">0</span>), <span class="dv">1</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>pr_treatment_X0 <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="fl">0.5</span>, <span class="at">sd =</span> <span class="fl">0.15</span>), <span class="dv">0</span>), <span class="dv">1</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine Into a Data Frame</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>ate_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">pr_treatment =</span> <span class="fu">c</span>(pr_treatment_X1, pr_treatment_X0),</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Treated"</span>, <span class="st">"Control"</span>), <span class="at">each =</span> <span class="dv">1000</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the Plot</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ate_data, <span class="fu">aes</span>(<span class="at">x =</span> pr_treatment, <span class="at">fill =</span> group)) <span class="sc">+</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span>   </span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">""</span>,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Probability of Receiving Treatment"</span>,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Treatment Status"</span>) <span class="sc">+</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="fu">percent_format</span>()) <span class="sc">+</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Treated"</span> <span class="ot">=</span> <span class="st">"#16cfe3"</span>, <span class="st">"Control"</span> <span class="ot">=</span> <span class="st">"#c00c09"</span>)) <span class="sc">+</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">blog_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Treatment Assignment Where Estimating the ATE is Appropriate</figcaption>
</figure>
</div>
</div>
</div>
<p>Here, we can see a distribution of treatment probabilities across the treated and control groups that warrants the estimation of the ATE. Across every treatment probability, there are both treated and control units. Every treated unit has an appropriate control counterfactual and every control units has an appropriate treated counterfactual. Effectively, the treated and control units serve as identical populations who differ only with respect to their treatment status. Any difference in outcome between these two populations can be interpreted as the effect when <em>every unit receives treatment</em> vs.&nbsp;<em>when no unit receives treatment</em>. However, such identical distributions are rare in practice, especially in observational research. Further, you might not care about the ATE anyways. You might just be interested in the effect of treatment for those units who actually took the treatment. If we wish to estimate this (the ATT), we would need a distribution of treatment probabilities that looks somewhat like the following plot below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Treatment Probabilities So That X1 Overlaps with Most of the Distribution of</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># X0 and X0 Overlaps Entirely with the Distribution of X1</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume That These Probabilities Derive From Confounders</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>pr_treatment_X1 <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="fl">0.5</span>, <span class="at">sd =</span> <span class="fl">0.08</span>), <span class="dv">0</span>), <span class="dv">1</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>pr_treatment_X0 <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="fl">0.3</span>, <span class="at">sd =</span> <span class="fl">0.17</span>), <span class="dv">0</span>), <span class="dv">1</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine Into a Data Frame</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>att_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">pr_treatment =</span> <span class="fu">c</span>(pr_treatment_X1, pr_treatment_X0),</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Treated"</span>, <span class="st">"Control"</span>), <span class="at">each =</span> <span class="dv">1000</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the Plot</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(att_data, <span class="fu">aes</span>(<span class="at">x =</span> pr_treatment, <span class="at">fill =</span> group)) <span class="sc">+</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span>   </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">""</span>,</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Probability of Receiving Treatment"</span>,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Treatment Status"</span>) <span class="sc">+</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="fu">percent_format</span>()) <span class="sc">+</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Treated"</span> <span class="ot">=</span> <span class="st">"#16cfe3"</span>, <span class="st">"Control"</span> <span class="ot">=</span> <span class="st">"#c00c09"</span>)) <span class="sc">+</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">blog_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Treatment Assignment Where Estimating the ATT is Appropriate</figcaption>
</figure>
</div>
</div>
</div>
<p>Here, we can see that the treatment probability distributions look a bit different now. As you might expect, in this scenario, treated units had a higher probability of receiving treatment while control units generally had a lower probability of receiving treatment. For right now, just focus on the the treatment probability for the treated units. Inspect the entire distribution. Note how, across every treatment probability (roughly 20% to 80%) there are control observations that can serve as counterfactuals for the treated units. Next, focus solely on the treatment probability distribution for the control units. For <em>some</em> of the observations, there is overlap with the treated units. But, for the entire distribution below 20%, there are no treated observations that can serve as counterfactuals. Therefore, we have no common support for these cases and our data does not support estimating counterfactuals.In this scenario, we have (or maybe we just want) to estimate the ATT. Basically, this means that we can estimate what the outcome would have been like for all treated units had they not received treatment. Knowing these counterfactual outcomes, we can estimate the effect of treatment for the treated units. If we want to estimate the <em>ATC</em>, we would need something that looks more like the following.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Treatment Probabilities So That X0 Overlaps with Most of the Distribution of</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># X1 and X1 Overlaps Entirely with the Distribution of X0</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume That These Probabilities Derive From Confounders</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>pr_treatment_X1 <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="fl">0.5</span>, <span class="at">sd =</span> <span class="fl">0.17</span>), <span class="dv">0</span>), <span class="dv">1</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>pr_treatment_X0 <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="fl">0.3</span>, <span class="at">sd =</span> <span class="fl">0.08</span>), <span class="dv">0</span>), <span class="dv">1</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine Into a Data Frame</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>atc_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">pr_treatment =</span> <span class="fu">c</span>(pr_treatment_X1, pr_treatment_X0),</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Treated"</span>, <span class="st">"Control"</span>), <span class="at">each =</span> <span class="dv">1000</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the Plot</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(atc_data, <span class="fu">aes</span>(<span class="at">x =</span> pr_treatment, <span class="at">fill =</span> group)) <span class="sc">+</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span>   </span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">""</span>,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Probability of Receiving Treatment"</span>,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Treatment Status"</span>) <span class="sc">+</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="fu">percent_format</span>()) <span class="sc">+</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Treated"</span> <span class="ot">=</span> <span class="st">"#16cfe3"</span>, <span class="st">"Control"</span> <span class="ot">=</span> <span class="st">"#c00c09"</span>)) <span class="sc">+</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">blog_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Treatment Assignment Where Estimating the ATC is Appropriate</figcaption>
</figure>
</div>
</div>
</div>
<p>Here, we get the inverse of the treatment probability distribution of the prior plot. The entire distribution for control units overlaps with treated observations, but there are segments of the treated distribution that do not overlap with the control observations. Therefore, many of the treated units do not have common support and we can not estimate counterfactual outcomes. In contrast, there <em>is</em> common support for all control observations, so we can estimate the ATC. The ATC is valuable because we can estimate <em>prescriptive</em> treatment effects. While the ATT gives us <em>retrospective</em> information (looking back, what effect did treatment have for the units who took treatment?), the ATC lets us know what the outcome <em>would</em> look like if those who did not receive treatment actually received it instead. In some cases, you might prefer to estimate the ATC, because the prescriptive question is certainly interesting. However, you can only estimate what your data supports.</p>
<p>And this leads me to a very tricky thing that can fly under the radar. You really only <em>should</em> estimate what your data supports. However, most researchers are estimating treatment effects using regression, and using regression will not stop you from estimating treatment effect that your data does not support. If you estimate the ATC, and your data does not support this, you won’t get an error. Your model won’t break. You’ll get a number and, if you’re not careful, you’ll interpret that number as something meaningful. Be careful! Regression would give you a number that is not sourced from the data but is sourced from your model’s best guess (or “extrapolation”) at what the data could be. In this case, you’d be estimating a counterfactual some of your data being your model’s best guess. That is not exactly compelling evidence. Other methods, such as matching methods, would prevent you from making this mistake. However, given the dominance of using regression to estimate treatment effects, it cannot be emphasized enough that you need to inspect your data carefully, be explicit about what effect you are trying to estimate, and be honest about whether your data supports such estimation.</p>
<p>Before I finish this section on positivity/common support and treatment effects, I want to talk about a couple more items that warrant a very brief discussion. First, I only mentioned three treatment effects in this section (the ATE, the ATT, and the ATC). There are more, and I would suggest looking into the following as a next step: a sample average treatment effect (this can be a SATE, a SATT, a SATC, etc.), a local average treatment effect (LATE), a conditional average treatment effect (CATE), and an intention-to-treat effect (ITT). Second, how do you go about estimating any of these treatment effects? Is your regression coefficient sufficient? In short, the answer is almost always “no” and interpreting raw regression output is a methodological pathology that should strive to be overcome. For a variety of statistical reasons that will not be touched up on here, strive to never take a coefficient or some other metric that your model will produce (odds ratio, hazard ratio, etc.) and interpret that as a treatment effect. Estimating treatment effects require a bit more nuance that, also, will not be covered here, but I think a fantastic resource to consider is the <a href="https://marginaleffects.com/files/marginaleffects_arel-bundock_greifer_heiss_jss5115.pdf">companion article</a> to the <code>{marginaleffects}</code> package. In addition, for beginners, I cannot recommend Andrew Heiss’s <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">blog post</a> about marginal effects.</p>
<p>Okay, I hope I have not lost you at this point. Next, we’ll be pivoting towards something a little different, but is equally important for making causal inferences.</p>
</section>
<section id="consistency" class="level1">
<h1>Consistency</h1>
<p>The consistency assumption is actually relatively simple, and won’t require any simulation to demonstrate. For the consistency assumption to be satisfied, our levels (or “dosage” in clinical terms) of treatment must be consistent across each unit that receives treatment. This kind of sounds like a no-brainer, but the temptation to violate the consistency assumption is pretty powerful and in the following example, I’ll demonstrate why.</p>
<p>Imagine that you were curious about whether a country being democratic causes that country to be more peaceful with its neighbors. In this case, democracy would be our treatment. How do you assign the “dosage” of treatment in this scenario? A very popular, but potentially incorrect, approach would be to assign democracy as a dummy. “Country X is a democracy, so 1. Country Y is not a democracy, so 0”. Is treatment consistent here? Think about <em>all</em> of the variation within democracies and non-democracies that we are collapsing into two categories. Because we are collapsing to a dummy, the most robust of democracies are treated as the same as the most fragile of democracies. Likewise, the strongest and most repressive dictatorships are lumped into the same category of competitive electoral non-democracies.</p>
<p>In this case, we could say that treatment is not very consistent here. Out of convenience, we’ve lumped a bunch of different levels of treatment together so that we can work with a simplistic measure of treatment. And this decision could be potentially very harmful for making causal inferences. Imagine if we did this in a more clinical scenario. Imagine that data was collected on a given hair-loss medication and imagine that such medication was allocated in dosages. If we established a random cut-off point to make treatment binary, that’s very problematic, because a small amount of dosage is still dosage and exposure to treatment. Likewise, a lot/the max of dosage is still very different from a decent amount of dosage.</p>
<p>In the end, it is always advisable to carefully think about how you are measuring your treatment. Are you using a binary variable and is that binary really appropriate? Or, are you collapsing a lot of important variation into two categories? Working with binary treatments is almost always easier, but convenience should not take priority unless you would like to be making <em>bad</em> causal inferences.</p>
</section>
<section id="non-interference" class="level1">
<h1>Non-Interference</h1>
<p>The non-interference assumption is often combined with the consistency assumption into something known as the Stable Unit Treatment Value Assumption (SUTVA). This combination is because both sub-assumptions concern themselves with whether treatment is <em>well-defined</em>. Consistency is one component of a well-defined treatment. If we start masking important variation in treatment into discrete categories, then our treatment is not well-defined. However, treatment can also not well-defined if it violates the assumption of non-interference.</p>
<p>This assumption breaks down when the treatment status of a given unit(s) impacts the treatment status of other units. In a randomized experiment, non-interference should hold because random chance alone <em>should</em> be influencing the treatment assignment. However, in observational settings, we do not have control over the treatment assignment. And it very well may be the case that the treatment assignment is “contagious” - one unit being treated causes a change in the probability of other unit receiving/not receiving treatment. A good example of this is any sort of spatial research.</p>
<p>Consider a research design that sought to estimate the causal effect of armed conflict (treatment) on economic development (outcome). A major red flag should pop up in this research design. Consider the image below depicting where civil conflict in particular has occurred and how often civil conflict has occurred from 1950 to 2020. Notice how geographically “bunched together” conflict/the frequency of conflict is? Conflict scholars have referred to this observation as “conflict contagion” and while conflict contagion as a substantive topic of interest has been studies heavily, its consequences for making causal inferences are rarely discussed.</p>
<p><img src="figures/civil-wars-map.png" class="img-fluid"></p>
<p>But such discussion is <em>very</em> warranted because, if conflict contagion is a well-documented phenomenon, and conflict is often treated as a treatment/exposure, then almost all of these research designs are almost certainly violating the non-interference assumption… So, why is this a big deal? It’s a big deal because our “control”/not-exposed units might actually be impacted by treatment, because of contagion. Think about it… If you’re a country bordering a conflict-dense region, are you <em>really</em> perfectly insulated from the effects of conflict? What about contagious aspects of conflict that might impact economic development such as political instability, foreign companies retreating assets from the region, etc. Sure, maybe you are not experiencing civil conflict <em>right now</em>, but being next to a country in conflict likely increases your probability of experiencing civil conflict and it certainly increases the chances that you experience <em>effects</em> from neighboring conflict that impacts economic development. This is why thinking about non-interference is so important. Our control observations are important because they serve to help construct our counterfactuals. But a counterfactual is not a good one if it is impacted by the factual! This is why it is always considering whether your treatment may be contagious.</p>
</section>
<section id="beyond-regression-and-the-cross-sectional" class="level1">
<h1>Beyond Regression and the Cross-Sectional</h1>
<p>You’ve probably noticed that I’ve exclusively used regression as a tool for estimating causal effects in this blog post. This is a choice I made out of convenience. However, there are other strategies one can use to estimate causal effects, such as matching or weighting techniques. These won’t be demonstrated here and, importantly, <em>using matching or weighting does not inherently make a research design more causal nor does it inherently lead to better causal inferences</em>. Matching and wieghting, like regression, are tools we can use to make causal inferences. In some cases, using either may be more appropriate than regression and, in others, vice versa. Crucially, under selection on observables, all approaches are still constrained by the assumption of no unobserved confounding. It is always more important to make sure you’ve directed plenty of attention towards the problem of confounding and give it the care it deserves before you go into statistical modeling. Thinking about regression v. matching v. weighting can take place after you’ve identified as many confounders as possible.</p>
<p>Additionally, in each of the simulated examples used in this blog post, <em>all</em> were reflective of cross-sectional data (data where each individual data point represents a unique unit at one point in time). If you were to add time into the mix (having unique units in unique time periods), things get a bit more complicated when trying to make causal inferences! I won’t go into detail here, but you can check out <a href="https://brian-lookabaugh.github.io/website-brianlookabaugh/blog/2024/dynamic-causal-inference/">another one of my blog posts</a> if you’re interested. If you find yourself wanting to make causal inferences and you are working with such longitudinal/panel data, pay serious attention to how the incorporation of time complicates causal inferences!</p>
</section>
<section id="readings-to-get-you-started" class="level1">
<h1>Readings to Get You Started</h1>
<p>This blog was meant to serve as <em>very</em> introductory material. It attempts to be a jack-of-all trades and, in turn, it masters none of the concepts touched on. However, I am attaching several introductory-friendly materials that, assuming you’re interested, should give you a much more solid foundation in causal inference… Good luck!</p>
<section id="general-introduction-to-causal-inference" class="level3">
<h3 class="anchored" data-anchor-id="general-introduction-to-causal-inference">General Introduction to Causal Inference</h3>
<ul>
<li><a href="https://theeffectbook.net/ch-Identification.html">The Effect, Chapter 5: Identification</a></li>
<li><a href="https://mixtape.scunning.com/04-potential_outcomes">Causal Inference: The Mixtape, Chapter 4: Potential Outcomes Causal Model</a></li>
<li><a href="https://www.cambridge.org/core/journals/british-journal-of-political-science/article/abs/mere-description/833643C6242D3A45D48BAAC3EF0C33D0">Mere Description</a></li>
<li><a href="https://journals.sagepub.com/doi/pdf/10.1177/1745691620921521">The Taboo Against Explicit Causal Inference in Nonexperimental Psychology</a></li>
<li><a href="https://ajph.aphapublications.org/doi/pdf/10.2105/AJPH.2018.304337?download=true">The C-Word: Scientiﬁc Euphemisms Do Not Improve Causal Inference From Observational Data</a></li>
<li><a href="https://hrr.w.uib.no/files/2019/01/Keele_2015_causal.pdf">The Statistics of Causal Inference: A View from Political Methodology</a></li>
</ul>
</section>
<section id="dags-and-control-variables" class="level3">
<h3 class="anchored" data-anchor-id="dags-and-control-variables">DAGs and Control Variables</h3>
<ul>
<li><a href="https://theeffectbook.net/ch-CausalDiagrams.html">The Effect, Chapter 6: Causal Diagrams</a></li>
<li><a href="https://theeffectbook.net/ch-DrawingCausalDiagrams.html">The Effect, Chapter 7: Drawing Causal Diagrams</a></li>
<li><a href="https://theeffectbook.net/ch-CausalPaths.html">The Effect, Chapter 8: Causal Paths and Closing Back Doors</a></li>
<li><a href="https://mixtape.scunning.com/03-directed_acyclical_graphs">Causal Inference: The Mixtape, Chapter 3: Directed Acyclic Graphs</a></li>
<li><a href="https://ftp.cs.ucla.edu/pub/stat_ser/r493.pdf">A Crash Course in Good and Bad Controls</a></li>
<li><a href="https://journals.sagepub.com/doi/pdf/10.1177/2515245917745629">Thinking Clearly About Correlations and Causation: Graphical Causal Models for Observational Data</a></li>
</ul>
</section>
<section id="regression-matching-and-weighting" class="level3">
<h3 class="anchored" data-anchor-id="regression-matching-and-weighting">Regression, Matching, and Weighting</h3>
<ul>
<li><a href="https://theeffectbook.net/ch-StatisticalAdjustment.html">The Effect, Chapter 13: Regression</a></li>
<li><a href="https://theeffectbook.net/ch-Matching.html">The Effect, Chapter 14: Matching</a></li>
<li><a href="https://www.randystevenson.com/wp-content/uploads/2022/09/Keele_Stevenson_2019.pdf">The Causal Interpretation of Estimated Associations in Regression Models</a></li>
<li><a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/ajps.12185">Does Regression Produce Representative Estimates of Causal Effects?</a></li>
<li><a href="https://gvpt.umd.edu/sites/gvpt.umd.edu/files/pubs/Hanmer%20and%20Kalkan%20AJPS%20Behind%20the%20Curve.pdf">Behind the Curve: Clarifying the Best Approach to Calculating Predicted Probabilities and Marginal Effects from Limited Dependent Variable Models</a></li>
<li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9005055/">Matching Methods for Confounder Adjustment: An Addition to the Epidemiologist’s Toolbox</a></li>
</ul>
</section>
<section id="causal-inference-beyond-the-cross-sectional" class="level3">
<h3 class="anchored" data-anchor-id="causal-inference-beyond-the-cross-sectional">Causal Inference Beyond the Cross-Sectional</h3>
<ul>
<li><a href="https://mixtape.scunning.com/08-panel_data">Causal Inference: The Mixtape, Chapter 8: Panel Data</a></li>
<li><a href="https://journals.sagepub.com/doi/pdf/10.1177/25152459241236149">The Causal Cookbook: Recipes for Propensity Scores, G-Computation, and Doubly Robust Standardization</a></li>
<li><a href="https://journals.sagepub.com/doi/pdf/10.1177/25152459221140842">These Are Not the Effects You Are Looking for: Causality and the Within-/Between-Persons Distinction in Longitudinal Data Analysis</a></li>
<li><a href="https://www.mattblackwell.org/files/papers/dynci.pdf">A Framework for Dynamic Causal Inference in Political Science</a></li>
<li><a href="https://gupea.ub.gu.se/bitstream/handle/2077/56563/gupea_2077_56563_1.pdf?sequence=1&amp;isAllowed=y">How to Make Causal Inferences with Time-Series Cross-Sectional Data under Selection on Observables</a></li>
<li><a href="https://imai.fas.harvard.edu/research/files/tscs.pdf">Matching Methods for Causal Inference with Time-Series Cross-Sectional Data</a></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/brian-lookabaugh\.github\.io\/website-brianlookabaugh\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>